<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathRain - Statistiche</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header>
    <nav class="nav-center">
        <a href="index.html">Home</a>
        <a href="problemi.html">Problemi</a>
        <a href="statistiche.html" class="active">Statistiche</a>
        <button id="googleLoginBtn" class="login-btn">Accedi con Google</button>
    </nav>
</header>

<main>
    <section class="content-box">
        <canvas id="eloChart" width="400" height="250"></canvas>
    </section>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getDatabase, ref, get, set, update, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

// Config
const firebaseConfig = {
    apiKey: "AIzaSyBzmwF02AuyFnvUZSZbta5Sx-xEMWHcYU4",
    authDomain: "math-c4f91.firebaseapp.com",
    databaseURL: "https://math-c4f91-default-rtdb.europe-west1.firebasedatabase.app/",
    projectId: "math-c4f91",
    storageBucket: "math-c4f91.firebasestorage.app",
    messagingSenderId: "222559643526",
    appId: "1:222559643526:web:566ef9854fdb15e8776e07"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const provider = new GoogleAuthProvider();

const loginBtn = document.getElementById("googleLoginBtn");
const ctx = document.getElementById("eloChart").getContext("2d");
let chart;
let userUid = null;

// LOGIN
async function login() {
    try {
        const result = await signInWithPopup(auth, provider);
        userUid = result.user.uid;
        loginBtn.style.display = "none";
        caricaGrafico(userUid);
    } catch(err) {
        console.error("Login fallito", err);
    }
}

loginBtn.addEventListener("click", login);

// STATO AUTH
onAuthStateChanged(auth, async (user) => {
    if(!user) {
        loginBtn.style.display = "inline-block";
    } else {
        userUid = user.uid;
        loginBtn.style.display = "none";
        caricaGrafico(userUid);
    }
});

// CARICA GRAFICO
function caricaGrafico(uid){
    const eloRef = ref(db, "utenti/"+uid+"/storicoELO");
    onValue(eloRef, snapshot=>{
        const data = snapshot.val();
        if(!data) return;

        const giorni = Object.keys(data).sort((a,b)=>a-b);
        const valori = giorni.map(g=>data[g]);

        if(chart){
            chart.data.labels = giorni;
            chart.data.datasets[0].data = valori;
            chart.update();
            return;
        }

        chart = new Chart(ctx, {
            type:"line",
            data:{
                labels: giorni,
                datasets:[{
                    label:"ELO",
                    data: valori,
                    borderColor: "black",
                    borderWidth:3,
                    fill:false,
                    tension:0.2,
                    pointBackgroundColor: valori.map((v,i)=>{
                        if(i===0) return "#000";
                        return v - valori[i-1]>=0 ? "#2ecc71" : "#e74c3c";
                    })
                }]
            },
            options:{
                responsive:true,
                plugins:{legend:{display:false}},
                scales:{y:{beginAtZero:false}}
            }
        });
    });
}
</script>

</body>
</html>
